<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日商簿記3級 模拟考试 App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        .loading { text-align: center; padding: 2rem; color: #64748b; }
        
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <div id="app" class="flex-grow flex flex-col items-center justify-center p-4">
        <div class="loading">
            正在加载题库... <br>
            <span class="text-xs text-red-400 mt-2 block" id="error-msg"></span>
        </div>
    </div>

    <footer class="p-4 text-center text-slate-400 text-sm">
        &copy; 2025 Boki Mock Exam
    </footer>

    <!-- 引入题库文件 -->
    <script src="./questions.js"></script>

    <script>
        // 错误检查
        window.onload = function() {
            if (typeof QUESTIONS === 'undefined') {
                document.getElementById('error-msg').innerText = 
                    "错误：无法加载题库数据 (questions.js)。\n请确保文件在同一目录下。";
                return;
            }
            init();
        };

        // ==========================================
        // Logic
        // ==========================================

        const EXAM_QUESTION_COUNT = 15; // 每次抽取的题目数量

        const state = {
            phase: 'start', // start, quiz, result
            examQuestions: [], // 当前考试抽取的题目列表
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: [],
            currentInputs: {
                debit: [{ id: 1, account: "", amount: "" }],
                credit: [{ id: 1, account: "", amount: "" }]
            },
            feedback: null
        };

        function init() {
            render();
        }

        // 洗牌算法：从题库中随机抽取 N 道题
        function getRandomQuestions(allQuestions, count) {
            // 创建副本以免修改原数组
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, Math.min(count, allQuestions.length));
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 

            if (state.phase === 'start') {
                app.appendChild(createStartScreen());
            } else if (state.phase === 'quiz') {
                app.appendChild(createQuizScreen());
            } else if (state.phase === 'result') {
                app.appendChild(createResultScreen());
            }
        }

        // --- Screens ---

        function createStartScreen() {
            const container = document.createElement('div');
            container.className = 'max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden text-center animate-[fadeIn_0.5s_ease-out]';
            
            container.innerHTML = `
                <div class="bg-blue-600 p-8">
                    <i class="ph ph-book-open-text text-6xl text-white mb-4"></i>
                    <h1 class="text-3xl font-bold text-white mb-2">簿記3級 模拟考试</h1>
                    <p class="text-blue-100">随机抽取 ${EXAM_QUESTION_COUNT} 题模式</p>
                </div>
                <div class="p-8 space-y-6">
                    <div class="flex justify-center space-x-8 text-slate-600">
                        <div class="flex flex-col items-center">
                            <span class="text-2xl font-bold text-blue-600">${QUESTIONS.length}</span>
                            <span class="text-xs text-slate-400">总题库</span>
                        </div>
                        <div class="text-slate-300 text-2xl">/</div>
                        <div class="flex flex-col items-center">
                            <span class="text-2xl font-bold text-green-600">${EXAM_QUESTION_COUNT}</span>
                            <span class="text-xs text-slate-400">本回题数</span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 text-left">
                        <p class="font-bold mb-1"><i class="ph ph-info"></i> 说明：</p>
                        <ul class="list-disc list-inside space-y-1 opacity-80">
                            <li>每次点击开始，系统会随机抽取新题。</li>
                            <li>包含动态科目选择功能。</li>
                        </ul>
                    </div>

                    <button onclick="handleStart()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                        生成试卷并开始 <i class="ph ph-arrow-right-bold"></i>
                    </button>
                </div>
            `;
            return container;
        }

        function createQuizScreen() {
            // 注意：这里使用 state.examQuestions 而不是全局 QUESTIONS
            const q = state.examQuestions[state.currentQuestionIndex];
            const container = document.createElement('div');
            container.className = 'w-full max-w-5xl bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col animate-[fadeIn_0.3s_ease-out]';

            // Header
            const header = document.createElement('div');
            header.className = 'bg-slate-50 p-6 border-b border-slate-100';
            header.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                         <button onclick="confirmQuit()" class="text-xs bg-white border border-slate-200 text-slate-500 px-2 py-1 rounded hover:bg-red-50 hover:text-red-500 transition" title="重新抽题">
                            <i class="ph ph-arrow-counter-clockwise"></i> 重开
                        </button>
                        <span class="text-xs font-bold text-blue-500 uppercase tracking-wider">Question ${state.currentQuestionIndex + 1} / ${state.examQuestions.length}</span>
                    </div>
                    <span class="text-xs text-slate-400 truncate max-w-[150px]">${q.source || 'Unknown Source'}</span>
                </div>
                <h2 class="text-xl font-bold text-slate-800 leading-relaxed">${q.text}</h2>
                ${q.choices ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-100 text-sm text-blue-800">
                        <span class="font-bold mr-2">可用科目群:</span> 
                        ${q.choices.join(' / ')}
                    </div>
                ` : ''}
            `;
            container.appendChild(header);

            // Body
            const body = document.createElement('div');
            body.className = 'p-6 md:p-8 bg-white flex-grow';
            
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-8';

            const debitCol = createEntryColumn('借方 (Debit)', 'debit', state.currentInputs.debit, q);
            const creditCol = createEntryColumn('貸方 (Credit)', 'credit', state.currentInputs.credit, q);

            grid.appendChild(debitCol);
            grid.appendChild(creditCol);
            body.appendChild(grid);
            container.appendChild(body);

            // Feedback
            if (state.feedback) {
                const feedbackDiv = document.createElement('div');
                const isCorrect = state.feedback === 'correct';
                feedbackDiv.className = `p-6 border-t ${isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'} animate-[slideUp_0.3s_ease-out]`;
                feedbackDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <i class="ph ${isCorrect ? 'ph-check-circle text-green-600' : 'ph-x-circle text-red-600'} text-2xl shrink-0"></i>
                        <div class="flex-grow">
                            <h3 class="font-bold ${isCorrect ? 'text-green-800' : 'text-red-800'} text-lg">
                                ${isCorrect ? '回答正确！' : '回答错误'}
                            </h3>
                            <p class="text-slate-700 mt-1">${q.explanation}</p>
                            
                            <div class="mt-4 bg-white p-4 rounded border border-slate-200">
                                <p class="text-xs text-slate-400 font-bold mb-2 uppercase">Correct Answer</p>
                                <div class="flex gap-8 text-sm font-mono">
                                    <div>
                                        <div class="text-slate-500 mb-1 border-b border-slate-100 pb-1">借方</div>
                                        ${q.correct.debit.map(d => `<div class="flex justify-between w-40"><span>${d.account}</span><span>${d.amount.toLocaleString()}</span></div>`).join('')}
                                    </div>
                                    <div>
                                        <div class="text-slate-500 mb-1 border-b border-slate-100 pb-1">貸方</div>
                                        ${q.correct.credit.map(c => `<div class="flex justify-between w-40"><span>${c.account}</span><span>${c.amount.toLocaleString()}</span></div>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(feedbackDiv);
            }

            // Footer
            const footer = document.createElement('div');
            footer.className = 'p-6 bg-slate-50 border-t border-slate-200 flex justify-end sticky bottom-0';
            
            if (!state.feedback) {
                footer.innerHTML = `
                    <button onclick="handleSubmitAnswer()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-md flex items-center gap-2">
                        <i class="ph ph-check-bold"></i> 确认仕訳
                    </button>
                `;
            } else {
                const isLast = state.currentQuestionIndex === state.examQuestions.length - 1;
                footer.innerHTML = `
                    <button onclick="handleNextQuestion()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-lg transition shadow-md flex items-center gap-2">
                        ${isLast ? '查看结果' : '下一题'} <i class="ph ph-arrow-right"></i>
                    </button>
                `;
            }
            container.appendChild(footer);

            return container;
        }

        function createEntryColumn(title, type, rowsData, currentQuestion) {
            const col = document.createElement('div');
            col.className = 'flex flex-col gap-4';
            
            const header = document.createElement('div');
            header.className = `font-bold text-lg pb-2 border-b-2 ${type === 'debit' ? 'border-blue-400 text-blue-700' : 'border-orange-400 text-orange-700'} flex justify-between items-center`;
            header.innerHTML = `<span>${title}</span>`;
            
            if (!state.feedback) {
                const addBtn = document.createElement('button');
                addBtn.className = "text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-2 py-1 rounded transition";
                addBtn.innerHTML = '<i class="ph ph-plus"></i> 增加行';
                addBtn.onclick = () => addRow(type);
                header.appendChild(addBtn);
            }
            col.appendChild(header);

            const rowsContainer = document.createElement('div');
            rowsContainer.className = 'space-y-3';
            
            const optionsToShow = (currentQuestion && currentQuestion.choices) 
                                  ? ["", ...currentQuestion.choices] 
                                  : (typeof DEFAULT_ACCOUNT_TITLES !== 'undefined' ? DEFAULT_ACCOUNT_TITLES : [""]);

            rowsData.forEach((row, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'flex gap-2 items-center animate-[fadeIn_0.3s_ease-out]';
                
                const select = document.createElement('select');
                select.className = `flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white ${!row.account ? 'text-slate-400' : 'text-slate-800'} ${state.feedback ? 'bg-slate-50' : ''}`;
                if (row.account) select.classList.remove('text-slate-400');
                
                select.disabled = !!state.feedback;
                select.onchange = (e) => {
                    e.target.classList.remove('text-slate-400');
                    updateInput(type, index, 'account', e.target.value);
                };
                
                optionsToShow.forEach(optTitle => {
                    const opt = document.createElement('option');
                    opt.value = optTitle;
                    opt.textContent = optTitle === "" ? (currentQuestion.choices ? "-- 选择 --" : "-- 科目 --") : optTitle;
                    opt.selected = row.account === optTitle;
                    select.appendChild(opt);
                });

                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = '金额';
                input.className = `w-1/3 p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-right font-mono ${state.feedback ? 'bg-slate-50' : ''}`;
                input.value = row.amount ? Number(row.amount).toLocaleString() : '';
                input.disabled = !!state.feedback;
                
                input.onblur = (e) => {
                    const val = e.target.value.replace(/,/g, '');
                    if(!isNaN(val) && val !== '') {
                        e.target.value = Number(val).toLocaleString();
                    }
                }
                input.oninput = (e) => {
                    const val = e.target.value.replace(/,/g, '');
                    updateInput(type, index, 'amount', val);
                };

                rowDiv.appendChild(select);
                rowDiv.appendChild(input);
                
                if (rowsData.length > 1 && !state.feedback) {
                    const delBtn = document.createElement('button');
                    delBtn.className = "text-slate-300 hover:text-red-500 p-1 transition";
                    delBtn.innerHTML = '<i class="ph ph-trash"></i>';
                    delBtn.onclick = () => removeRow(type, index);
                    rowDiv.appendChild(delBtn);
                }

                rowsContainer.appendChild(rowDiv);
            });

            col.appendChild(rowsContainer);
            return col;
        }

        function createResultScreen() {
            // 这里的总题数使用本次抽取的数量
            const totalQ = state.examQuestions.length;
            const percentage = Math.round((state.score / totalQ) * 100);
            const passed = percentage >= 70;
            
            const container = document.createElement('div');
            container.className = 'max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden';
            
            container.innerHTML = `
                <div class="p-8 text-center ${passed ? 'bg-green-600' : 'bg-slate-700'}">
                    <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-white mb-4 shadow-lg">
                        <span class="text-3xl font-black ${passed ? 'text-green-600' : 'text-slate-700'}">
                            ${percentage}%
                        </span>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-1">
                        ${passed ? '合格！' : '不合格'}
                    </h2>
                    <p class="text-white/80">
                        答对 ${state.score} / ${totalQ} 题
                    </p>
                </div>
                <div class="p-6 bg-slate-50 border-t border-slate-100">
                    <button onclick="handleStart()" class="w-full bg-white border-2 border-slate-200 hover:border-blue-500 hover:text-blue-600 text-slate-600 font-bold py-3 px-6 rounded-xl transition flex items-center justify-center gap-2">
                        <i class="ph ph-arrow-counter-clockwise text-xl"></i>
                        <span>抽取新题并挑战</span>
                    </button>
                </div>
            `;
            return container;
        }

        // --- State Handlers ---

        function handleStart() {
            // 1. 随机抽取 15 题
            state.examQuestions = getRandomQuestions(QUESTIONS, EXAM_QUESTION_COUNT);
            
            // 2. 重置其他状态
            state.phase = 'quiz';
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.userAnswers = [];
            state.feedback = null;
            resetInputs();
            
            render();
        }
        
        function confirmQuit() {
            if(confirm('确定要退出当前考试并重新抽取题目吗？')) {
                // 直接重新开始（也可以选择回到 phase='start'）
                // 这里我们选择回到开始界面，让用户手动点击生成
                state.phase = 'start';
                render();
            }
        }

        function resetInputs() {
            state.currentInputs = {
                debit: [{ id: Date.now(), account: "", amount: "" }],
                credit: [{ id: Date.now()+1, account: "", amount: "" }]
            };
        }

        function addRow(type) {
            state.currentInputs[type].push({ id: Date.now(), account: "", amount: "" });
            render();
        }

        function removeRow(type, index) {
            state.currentInputs[type].splice(index, 1);
            render();
        }

        function updateInput(type, index, field, value) {
            state.currentInputs[type][index][field] = value;
        }

        function handleSubmitAnswer() {
            const q = state.examQuestions[state.currentQuestionIndex];
            const cleanDebit = cleanEntries(state.currentInputs.debit);
            const cleanCredit = cleanEntries(state.currentInputs.credit);
            
            const isDebitCorrect = compareEntries(cleanDebit, q.correct.debit);
            const isCreditCorrect = compareEntries(cleanCredit, q.correct.credit);
            const isCorrect = isDebitCorrect && isCreditCorrect;

            if (isCorrect) state.score++;
            state.feedback = isCorrect ? 'correct' : 'incorrect';
            
            state.userAnswers.push({
                questionId: q.id,
                isCorrect: isCorrect,
                userDebit: cleanDebit,
                userCredit: cleanCredit
            });

            render();
        }

        function handleNextQuestion() {
            if (state.currentQuestionIndex < state.examQuestions.length - 1) {
                state.currentQuestionIndex++;
                state.feedback = null;
                resetInputs();
                render();
            } else {
                state.phase = 'result';
                render();
            }
        }

        function cleanEntries(entries) {
            return entries
                .filter(e => e.account !== "" && e.amount !== "")
                .map(e => ({
                    account: e.account,
                    amount: parseInt(String(e.amount).replace(/,/g, ''), 10) || 0
                }));
        }

        function compareEntries(userEntries, correctEntries) {
            const userSet = userEntries.map(e => `${e.account}|${e.amount}`).sort();
            const correctSet = correctEntries.map(e => `${e.account}|${e.amount}`).sort();
            return JSON.stringify(userSet) === JSON.stringify(correctSet);
        }
    </script>
</body>
</html>